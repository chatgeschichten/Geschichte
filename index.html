<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>KI‚ÄëAbenteuer</title>
  <meta name="theme-color" content="#0b141a" />
  <link rel="manifest" href="manifest.json" />
  <style>
    /* WhatsApp Dark Mode Palette */
    :root{
      --bg:#0b141a;        /* App-Hintergrund */
      --panel:#111b21;     /* Chat-Hintergrund */
      --panel2:#0b141a;    /* Seitenleiste/Header */
      --in:#202c33;        /* eingehende Bubble */
      --out:#005c4b;       /* ausgehende Bubble (gr√ºn) */
      --text:#e9edef;      /* Prim√§rtext */
      --muted:#8696a0;     /* Sekund√§r */
      --accent:#25d366;    /* WhatsApp Gr√ºn */
      --accent2:#128c7e;   /* Darker Gr√ºn */
      --btn:#1f2c34;       /* Buttonfl√§chen */
      --border:#1f2c34;    /* Kanten */
      --choice:#0e3b33;    /* Choice-Hover */
      --narr:#182229;      /* Erz√§hler-Box */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:var(--panel2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;padding:12px 16px}
    header .title{font-weight:600}
    .wrap{max-width:980px;margin:0 auto;display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
    @media(max-width:900px){.wrap{grid-template-columns:1fr}}

    aside{background:var(--panel2);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .side{padding:14px;display:flex;flex-direction:column;gap:12px}
    label{font-size:12px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted)}
    select,button,input,textarea{border-radius:12px;border:1px solid var(--border);background:var(--btn);color:var(--text);padding:10px 12px;font-size:14px}
    button{cursor:pointer}
    .hint{font-size:12px;color:var(--muted)}

    main{background:var(--panel);border:1px solid var(--border);border-radius:14px;display:flex;flex-direction:column;height:80svh}
    .chat{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:10px;background:var(--panel);}
    .row{display:flex;gap:6px}
    .bubble{max-width:75%;padding:10px 13px;border-radius:16px;line-height:1.33;font-size:15px;position:relative;word-wrap:break-word}
    .in{align-self:flex-start;background:var(--in)}
    .out{align-self:flex-end;background:var(--out)}
    .meta{font-size:11px;color:var(--muted);margin:0 6px}
    .narr{align-self:center;background:var(--narr);border:1px solid var(--border);max-width:90%;font-style:italic}
    .name{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}

    .choices{border-top:1px solid var(--border);display:flex;flex-wrap:wrap;gap:8px;padding:10px;background:var(--panel2)}
    .choice{background:var(--btn);border:1px solid var(--border);padding:10px 12px;border-radius:12px}
    .choice:hover{background:var(--choice)}

    .composer{display:flex;gap:8px;border-top:1px solid var(--border);padding:10px;background:var(--panel2)}
    .composer input{flex:1}
    .progress{height:4px;background:#0a141a}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
    .ad{min-height:72px;border-top:1px dashed var(--border);display:flex;align-items:center;justify-content:center;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="title">üß≠ KI‚ÄëAbenteuer ‚Ä¢ WhatsApp‚ÄëDark</div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <button id="newBtn">Neues Abenteuer</button>
    </div>
  </header>

  <div class="wrap">
    <aside>
      <div class="side">
        <div>
          <label>Modus</label>
          <select id="mode">
            <option value="adventure" selected>Text‚ÄëAdventure (Entscheidungen)</option>
            <option value="flirt">Flirt‚ÄëBerater (dezente Tipps)</option>
            <option value="buddy">Bester‚ÄëFreund‚ÄëChat</option>
          </select>
        </div>
        <div>
          <label>Stil</label>
          <select id="style">
            <option>Realistisch</option>
            <option>Dramatisch</option>
            <option>Horror</option>
            <option>Comedy</option>
            <option>High‚ÄëSchool</option>
            <option>Familiengeheimnis</option>
          </select>
        </div>
        <div>
          <label>Setting</label>
          <input id="setting" placeholder="z. B. Nachtzug, Klassenchat, WG‚ÄëK√ºche" />
        </div>
        <div class="hint">Fragen an den Spieler erscheinen **als Buttons unter dem Chat**, nicht als Chat‚ÄëNachrichten.</div>
        <button id="startBtn">‚ñ∂Ô∏è Abenteuer starten</button>
      </div>
    </aside>

    <main>
      <div class="chat" id="chat"></div>
      <div class="choices" id="choices"></div>
      <div class="composer">
        <input id="input" placeholder="Eigene Antwort tippen (optional)‚Ä¶" />
        <button id="send">Senden</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="ad">Werbeplatz</div>
    </main>
  </div>

<script>
// ‚Äî‚Äî Minimaler State ‚Äî‚Äî
const $ = (q)=>document.querySelector(q);
const chat = $('#chat'), choices = $('#choices');
const bar = $('#bar');
const input = $('#input');
const modeSel = $('#mode');
const styleSel = $('#style');
const settingInp = $('#setting');
const sendBtn = $('#send');
const startBtn = $('#startBtn');
const newBtn = $('#newBtn');

let session = { turns: [], seed: Math.floor(Math.random()*1e9) };
function reset(){ session = { turns: [], seed: Math.floor(Math.random()*1e9) }; chat.innerHTML=''; choices.innerHTML=''; updateBar(0) }
function updateBar(p){ bar.style.width = Math.max(3, Math.min(100, p)) + '%'; }

function bubble(role, text, name){
  const div = document.createElement('div');
  div.className = 'bubble ' + (role==='you'?'out': role==='narrator'?'narr':'in');
  div.innerHTML = (name?`<span class="name">${name}</span>`:'') + text;
  chat.appendChild(div);
  const meta = document.createElement('div'); meta.className='meta'; meta.textContent = role==='you'?'Du': (role==='narrator'?'Erz√§hler':'Gegen√ºber');
  chat.appendChild(meta);
  chat.scrollTop = chat.scrollHeight;
}

function showChoices(arr){
  choices.innerHTML='';
  if(!arr || !arr.length){ choices.style.display='none'; return; }
  arr.forEach(c=>{
    const b = document.createElement('button'); b.className='choice'; b.textContent = c.label;
    b.addEventListener('click', ()=>{
      // Spielerwahl erscheint NICHT als Chat-Nachricht, nur interner Turn
      pickChoice(c.id);
    });
    choices.appendChild(b);
  });
  choices.style.display='flex';
}

async function pickChoice(choiceId){
  await sendToAI({choiceId});
}

async function sendFreeText(){
  const val = input.value.trim(); if(!val) return; input.value='';
  // Eigene Nachricht wird im Chat angezeigt
  bubble('you', escapeHtml(val));
  await sendToAI({userText: val});
}

function escapeHtml(s){return s.replace(/[&<>\"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]))}

async function sendToAI(payload){
  // UI sperren
  sendBtn.disabled = true; startBtn.disabled = true; updateBar(20);
  try{
    const body = {
      mode: modeSel.value,
      style: styleSel.value,
      setting: settingInp.value,
      seed: session.seed,
      history: session.turns,
      payload
    };
    const res = await fetch('/.netlify/functions/ai', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
    if(!res.ok){ throw new Error('KI‚ÄëServer nicht erreichbar'); }
    const data = await res.json();
    // data = { messages:[{role:'narrator'|'character', name?, text}], choices:[{id,label}], progress }
    if(Array.isArray(data.messages)){
      data.messages.forEach(m=> bubble(m.role==='character'?'them':m.role, escapeHtml(m.text), m.name||''));
    }
    showChoices(data.choices||[]);
    session.turns.push({you: payload.userText||null, choiceId: payload.choiceId||null, ai:data});
    updateBar(data.progress ?? Math.min(100, 10 + session.turns.length*10));
  }catch(e){ bubble('narrator', '‚ö†Ô∏è Fehler: '+e.message+' ‚Äî Pr√ºfe dein Hosting/Function.'); }
  finally{ sendBtn.disabled=false; startBtn.disabled=false; }
}

startBtn.addEventListener('click', ()=>{ reset(); sendToAI({start:true}); });
newBtn.addEventListener('click', ()=>{ reset(); });
sendBtn.addEventListener('click', sendFreeText);
input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendFreeText(); });
</script>
</body>
</html>